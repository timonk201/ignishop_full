<?php

namespace Database\Seeders;

use App\Models\Review;
use App\Models\Order;
use App\Models\User;
use App\Models\Product;
use Illuminate\Database\Seeder;
use Carbon\Carbon;

class ReviewSeeder extends Seeder
{
    // Расширенный список обобщённых отзывов для разных рейтингов
    private $comments = [
        1 => [
            'Товар оказался ниже ожиданий, качество оставляет желать лучшего.',
            'Очень разочарован покупкой, не рекомендую никому.',
            'Проблемы с доставкой и состоянием товара, ужасный опыт.',
            'Качество товара просто отвратительное, не стоит своих денег.',
            'Разочарован, товар пришел в повреждённом виде.',
            'Ужасное качество, деньги на ветер.',
            'Не соответствует описанию, очень плохое качество.',
            'Доставка задержалась, товар некачественный.',
            'Полное разочарование, не покупайте.',
            'Очень низкое качество материалов.',
            'Товар сломался на второй день использования.',
            'Не работает как заявлено, брак.',
            'Ужасный сервис и качество товара.',
            'Не соответствует фотографиям, обман.',
            'Очень плохое качество сборки.',
        ],
        2 => [
            'Товар работает, но есть недочёты в качестве.',
            'Средний продукт, ничего особенного, ожидал большего.',
            'Доставка задержалась, товар в порядке, но не впечатлил.',
            'Качество среднее, можно было бы и лучше.',
            'Не самый лучший выбор, но для разового использования сойдёт.',
            'Нормальный товар, но есть дефекты.',
            'Работает, но не очень надёжно.',
            'Среднее качество за свои деньги.',
            'Есть проблемы с функциональностью.',
            'Не очень удобный в использовании.',
            'Качество сборки оставляет желать лучшего.',
            'Нормальный товар, но есть недочёты.',
            'Средний продукт, ожидал большего.',
            'Работает, но не идеально.',
            'Приемлемое качество, но есть недостатки.',
        ],
        3 => [
            'Нормальный товар за свою цену, без нареканий.',
            'Удовлетворяет базовым ожиданиям, но без изысков.',
            'Хорошее соотношение цены и качества, ничего лишнего.',
            'Товар соответствует описанию, но не более того.',
            'Средний вариант, можно брать, если бюджет ограничен.',
            'Нормальное качество, без особых претензий.',
            'Средний товар, соответствует цене.',
            'Удовлетворительное качество.',
            'Нормальный продукт для повседневного использования.',
            'Средний вариант, без особых достоинств и недостатков.',
            'Приемлемое качество за свои деньги.',
            'Обычный товар, без излишеств.',
            'Нормальное качество, без сюрпризов.',
            'Средний продукт, без особых ожиданий.',
            'Удовлетворительное качество, без претензий.',
        ],
        4 => [
            'Отличный товар, рекомендую к покупке всем!',
            'Качество на уровне, доставка быстрая, доволен.',
            'Очень доволен покупкой, всё как ожидал и даже лучше.',
            'Прекрасный продукт, буду заказывать ещё.',
            'Хорошее качество и удобство использования, рекомендую.',
            'Отличное соотношение цены и качества.',
            'Очень хороший товар, превзошёл ожидания.',
            'Качественный продукт, доволен покупкой.',
            'Хорошее качество, удобный в использовании.',
            'Отличный товар, соответствует описанию.',
            'Очень доволен качеством и функциональностью.',
            'Хороший продукт, рекомендую к покупке.',
            'Отличное качество, удобный дизайн.',
            'Очень хороший товар, без нареканий.',
            'Качественный продукт, стоит своих денег.',
        ],
        5 => [
            'Великолепный продукт, превзошёл все ожидания!',
            'Идеально, качество на высоте, доставка супер!',
            'Лучшая покупка, буду заказывать ещё и советовать друзьям!',
            'Отличный товар, работает безупречно, очень доволен.',
            'Превосходное качество, доставка быстрая, полный восторг!',
            'Идеальный товар, превзошёл все ожидания!',
            'Потрясающее качество, очень доволен покупкой!',
            'Лучший товар в своей категории!',
            'Великолепное качество, превосходный дизайн!',
            'Идеальное соотношение цены и качества!',
            'Потрясающий продукт, рекомендую всем!',
            'Лучшая покупка за последнее время!',
            'Великолепное качество, очень доволен!',
            'Идеальный товар, превзошёл ожидания!',
            'Потрясающее качество, стоит своих денег!',
        ],
    ];

    public function run()
    {
        $users = User::all();
        // Получаем только завершенные заказы
        $orders = Order::where('status', 'completed')->get();

        foreach ($users as $user) {
            // Получаем заказы пользователя
            $userOrders = $orders->where('user_id', $user->id);

            foreach ($userOrders as $order) {
                // Извлекаем product_ids из массива items
                $purchasedProductIds = collect($order->items)->pluck('id')->toArray() ?? [];

                // Генерация от 1 до 5 отзывов на заказ (увеличено с 1-3 до 1-5)
                $reviewCount = rand(1, 5);
                for ($i = 0; $i < $reviewCount; $i++) {
                    if (empty($purchasedProductIds)) {
                        continue;
                    }

                    $productId = $purchasedProductIds[array_rand($purchasedProductIds)];
                    $product = Product::find($productId);

                    // Проверяем, что товар существует, подтвержден и на него еще нет отзыва от этого пользователя
                    if (!$product ||
                        !$product->is_approved ||
                        Review::where('user_id', $user->id)
                            ->where('product_id', $productId)
                            ->where('order_id', $order->id)
                            ->exists()) {
                        continue;
                    }

                    $rating = rand(1, 5);

                    // 30% шанс, что отзыв будет без комментария
                    $comment = null;
                    if (rand(1, 100) <= 70) {
                        $comment = $this->comments[$rating][array_rand($this->comments[$rating])] ?? null;
                    }

                    Review::create([
                        'user_id' => $user->id,
                        'product_id' => $productId,
                        'order_id' => $order->id,
                        'rating' => $rating,
                        'comment' => $comment,
                        'image' => null,
                        'created_at' => Carbon::now()->subDays(rand(0, 30)),
                        'updated_at' => Carbon::now(),
                    ]);
                }
            }
        }
    }
}
